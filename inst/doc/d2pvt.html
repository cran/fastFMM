<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Example fastFMM application to variable trial lengths</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">

div.csl-bib-body { }
div.csl-entry {
clear: both;
margin-bottom: 0em;
}
.hanging div.csl-entry {
margin-left:2em;
text-indent:-2em;
}
div.csl-left-margin {
min-width:2em;
float:left;
}
div.csl-right-inline {
margin-left:2em;
padding-left:1em;
}
div.csl-indent {
margin-left: 2em;
}
</style>

<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Example fastFMM application to variable
trial lengths</h1>



<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">suppressMessages</span>(<span class="fu">library</span>(fastFMM))</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">suppressMessages</span>(<span class="fu">library</span>(dplyr))</span></code></pre></div>
<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>Version 1.0+ of <code>fastFMM</code> allows users to fit concurrent
functional mixed models, which are particularly useful for inference on
experiments with variable trial lengths. In <span class="citation">Xin
et al. (<a href="#ref-xin_capturing_2025">2025</a>)</span>, we described
an example analysis on a dataset where mice receive rewards at different
times for each trial, with data sourced from <span class="citation">Machen et al. (<a href="#ref-machen_encoding_2025">2025</a>)</span>. In this vignette, we
provide a detailed walkthrough for this portion, with the goal of
demonstrating how to fit these models and providing more in-depth
interpretation and clarification. For a more general introduction to the
fast univariate inference method and <code>fastFMM</code>, please refer
to the main vignette, “Introduction to fastFMM model fitting” <span class="citation">(<a href="#ref-cui_fastfmm_2025">Cui, Loewinger, and
Xin 2025</a>)</span>.</p>
</div>
<div id="experimental-design" class="section level2">
<h2>Experimental design</h2>
<p>For this vignette, we sourced data from “The encoding of
interoceptive-based predictions by the paraventricular nucleus of the
thalamus D2+ neurons”, which includes photometry signals recorded from
mice in a foraging-like task <span class="citation">(<a href="#ref-machen_encoding_2025">Machen et al. 2025</a>)</span>.
Experimenters placed mice in a corridor and provided a food reward when
the mice arrived in a specified reward zone at the end of the corridor.
Though the original paper included different types of rewards and
whether mice were hungry or satiated, we will only focus on comparing
the signal associated with receiving a strawberry milkshake reward (SMS)
versus a water reward. Observations from these trials are available
within <code>fastFMM</code> as the dataset
<code>fastFMM::d2pvt</code>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>d2pvt <span class="ot">&lt;-</span> fastFMM<span class="sc">::</span>d2pvt</span></code></pre></div>
<div id="variable-trial-lengths" class="section level3">
<h3>Variable trial lengths</h3>
<p>For this experiment, we want trials to include both the approaching
phase and reward phase of the experiment. However, defining trials based
on reward latency introduces variation in the trial lengths. Standard
methods of summarizing over the trials (such as AUC, averaging, or
summing) can complicate statistical analyses and the interpretation of
results. Thus, a non-concurrent model can produce coefficients that can
be difficult to interpret, which we described in detail in <span class="citation">Xin et al. (<a href="#ref-xin_capturing_2025">2025</a>)</span>.</p>
<p>In this vignette, we will demonstrate how variable trial lengths can
be modeled as an interaction between a term of interest and an indicator
of whether the trial is ongoing. Specifically, we incorporate a
functional covariate corresponding to whether the mouse has received the
reward in a trial and include an interaction between the reward type and
the functional covariate. We then compare the results to a
non-concurrent model with latency as a covariate. Within <span class="citation">Xin et al. (<a href="#ref-xin_capturing_2025">2025</a>)</span>, we also compare this
approach to two different non-functional linear mixed models, which we
skip here for brevity.</p>
</div>
<div id="data-processing" class="section level3">
<h3>Data processing</h3>
<p>We converted the scalar covariate of <code>latency</code> (i.e., the
time, in seconds, for a mouse to receive the reward in a given trial) to
the functional covariate <code>rewarded</code> (also referred to as RZ,
or reward zone in later models). We set <code>rewarded = 0</code> at
trial timepoints earlier than <code>latency</code> and <code>= 1</code>
for timepoints later than <code>latency</code>. We also translate and
scale trial to the interval <code>[0, 1]</code> where 0 is Trial 0 and 1
is the maximum trial number across all mice.</p>
<p>The functional outcome of <code>photometry</code> (the measured
signal) and the functional covariate of <code>rewarded</code> are
encoded as <span class="math inline">\(N \times L\)</span> matrix
columns within <code>d2pvt</code>, where <span class="math inline">\(N\)</span> is the total number of observations and
<span class="math inline">\(L\)</span> is the size of the functional
domain. It is sometimes convenient to unravel these matrices into
separate columns, especially for visualization purposes.
<code>fastFMM::fui</code> can handle functional data in either form.
However, the prefixes of all included variables need to be unique, as
the function relies on string matching to detect the proper functional
outcome and covariates.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="fu">class</span>(d2pvt<span class="sc">$</span>photometry)</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="fu">dim</span>(d2pvt<span class="sc">$</span>photometry)</span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>d2pvt <span class="ot">&lt;-</span> <span class="fu">cbind</span>(</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>  d2pvt <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>photometry, <span class="sc">-</span>rewarded), </span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>  <span class="co"># this unravels the matrices into data frames</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(d2pvt<span class="sc">$</span>photometry), </span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(d2pvt<span class="sc">$</span>rewarded)</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>)</span></code></pre></div>
<p>For the concurrent model, it is also necessary to remove functional
covariates with zero variance. In practice, the cutoff for the column
variance may need to be higher than zero based on the other predictors
and the total number of observations. Here, we applied a cutoff of 0.01.
An example of how <code>rewarded</code> is encoded is displayed
below.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># Remove columns of all zeros or all ones</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>zero_var <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>  <span class="fu">select</span>(d2pvt, rewarded_1<span class="sc">:</span>rewarded_121), </span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>  <span class="cf">function</span>(x) </span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>    <span class="fu">var</span>(x) <span class="sc">&lt;=</span> <span class="fl">0.01</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>) </span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>zero_var_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="st">&quot;photometry_&quot;</span>, <span class="fu">which</span>(zero_var)), </span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="st">&quot;rewarded_&quot;</span>, <span class="fu">which</span>(zero_var))</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>)</span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>  </span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>d2pvt_nonzero <span class="ot">&lt;-</span> d2pvt[, <span class="sc">!</span><span class="fu">colnames</span>(d2pvt) <span class="sc">%in%</span> zero_var_cols]</span></code></pre></div>
</div>
</div>
<div id="concurrent-model-with-an-interaction-term" class="section level2">
<h2>Concurrent model with an interaction term</h2>
<p>Within this section, let <span class="math inline">\(i\)</span> index
the mouse ID and <span class="math inline">\(j\)</span> index the trial.
Furthermore, assume random effects and noise are Normally distributed.
We specified the <strong>concurrent</strong> model as</p>
<p><span class="math display">\[
Y_{i, j}(s) =
\beta_0 (s) + \gamma_{i, 0} (s) +
[\beta_1 (s) + \gamma_{i, 1} (s)] \texttt{SMS}_{i, j} +
\beta_2 (s) \texttt{RZ}_{i, j} (s) +
\beta_3 (s) \texttt{SMS}_{i, j} \texttt{RZ}_{i, j} (s) +
\epsilon_{i, j} (s),
\]</span></p>
<p>where we define the covariates</p>
<ul>
<li><span class="math inline">\(\texttt{RZ}_{i, j} (s)\)</span>: whether
the mouse has received the reward , with 1 meaning rewarded and 0
meaning not yet rewarded by timepoint <span class="math inline">\(s\)</span>, and</li>
<li><span class="math inline">\(\texttt{SMS}_{i, j}\)</span>: the trial
outcome, where 1 indicates SMS reward and 0 indicates water reward.</li>
</ul>
<p>Within the data frame, the covariate <span class="math inline">\(\texttt{RZ} (s_l)\)</span> corresponds to the
column <code>rewarded_l</code>, where <span class="math inline">\(l\)</span> is some integer indexing the functional
domain.</p>
<p>In this model, the fixed effects coefficients are interpreted as:</p>
<ul>
<li><span class="math inline">\(\beta_0(s)\)</span>: the mean signal on
a water trial at a timepoint <span class="math inline">\(s\)</span> when
the reward has not yet been received, i.e., when <span class="math inline">\(\texttt{RZ}_{i, j} (s) = \texttt{SMS}_{i, j} =
0\)</span>,</li>
<li><span class="math inline">\(\beta_1 (s)\)</span>: the mean
difference in signal between SMS and water trials at a timepoint <span class="math inline">\(s\)</span> when the reward has not yet been
received,</li>
<li><span class="math inline">\(\beta_2 (s)\)</span>: the average
difference between approach and reward in water trials at time <span class="math inline">\(s\)</span>, and</li>
<li><span class="math inline">\(\beta_3 (s)\)</span>: the difference in
differences <span class="math inline">\(A - B\)</span> between A) the
average signal difference between approach and reward on SMS trials, and
B) the average difference in signal values between approach and reward
on water trials (i.e., <span class="math inline">\(\beta_2\)</span>), at
trial timepoint <span class="math inline">\(s\)</span>,</li>
</ul>
<p>and the random effects are interpreted as:</p>
<ul>
<li><span class="math inline">\(\gamma_{i, 0} (s)\)</span>: the random
intercept for mouse <span class="math inline">\(i\)</span>, or the
subject-specific average perturbation of <span class="math inline">\(\beta_0 (s)\)</span> such that <span class="math inline">\(\beta_0 (s) + \gamma_{i, 0} (s)\)</span> is the
average signal for mouse <span class="math inline">\(i\)</span> on water
trials at time <span class="math inline">\(s\)</span> when the reward
has not yet been received, and</li>
<li><span class="math inline">\(\gamma_{i, 1} (s)\)</span>: the random
slope for mouse <span class="math inline">\(i\)</span>, or the
subject-specific average perturbation of <span class="math inline">\(\beta_1 (s)\)</span> such that <span class="math inline">\(\beta_1 (s) + \gamma_{i, 1} (s)\)</span> is the
average photometry signal change associated with being in an SMS trial
for mouse <span class="math inline">\(i\)</span> at time <span class="math inline">\(s\)</span> when the reward has not yet been
received.</li>
</ul>
<p>The concurrent model can be fit as follows:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>concurrent <span class="ot">&lt;-</span> fastFMM<span class="sc">::</span><span class="fu">fui</span>(</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>  photometry <span class="sc">~</span> SMS <span class="sc">*</span> rewarded <span class="sc">+</span> (SMS <span class="sc">|</span> id), </span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>  d2pvt_nonzero, </span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>  <span class="at">concurrent =</span> <span class="cn">TRUE</span>, </span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>  <span class="at">silent =</span> <span class="cn">TRUE</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>)</span></code></pre></div>
<p>As previously mentioned, the concurrent model cannot fit timepoints
when the functional covariates do not vary across animals or trials
(i.e., have zero or near-zero variance), so we fit to the data
<code>d2pvt_nonzero</code>, a subset of <code>d2pvt</code>. In this
case, the functional covariate <code>rewarded</code> is the same across
all mice at the beginning and end of the trial.</p>
</div>
<div id="interpretation-and-discussion" class="section level2">
<h2>Interpretation and discussion</h2>
<div id="plotting-the-models" class="section level3">
<h3>Plotting the models</h3>
<p>The raw outputs from <code>fui</code> reflect the indices of the
functional domain. When visualizing the results with
<code>plot_fui</code>, we can rescale the x-axis to the sampling rate (8
Hz) and shift it to reflect the trial start time (3 seconds after the
start of recording). In the concurrent case, we also need to adjust the
trial start time to reflect the discarded data points at the beginning
of the trial.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>sampling_Hz <span class="ot">&lt;-</span> <span class="dv">8</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>dummy <span class="ot">&lt;-</span> fastFMM<span class="sc">::</span><span class="fu">plot_fui</span>(</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>  concurrent,</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>  <span class="at">x_rescale =</span> sampling_Hz,</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>  <span class="co"># 30 / sampling_Hz corresponds to the discarded columns</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>  <span class="at">align_x =</span> <span class="dv">3</span> <span class="sc">-</span> <span class="dv">30</span> <span class="sc">/</span> sampling_Hz</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>)</span></code></pre></div>
<p>At first, the concurrent model’s coefficients might be surprising, as
it seems that <code>SMS</code> has no contribution to the signal change
within a trial. However, <span class="math inline">\(\beta_1
(s)\)</span> (the fixed coefficient corresponding to <code>SMS</code>)
is the average effect associated with being in an SMS trial while the
mouse has <em>not yet</em> received the reward. Thus, because a mouse
should not be affected by the reward before receiving it, then <span class="math inline">\(\beta_1 (s) \approx 0\)</span> for all values of
<span class="math inline">\(s\)</span>.</p>
<p>As an aside, the term <code>SMS * rewarded</code> implicitly includes
the non-interaction terms <code>SMS + rewarded</code>. In this case,
because the effect of the strawberry milkshake should be zero unless the
value of <code>rewarded</code> is 1, it would also be valid to recode
the formula as <code>reward + SMS:rewarded</code>, removing the
<code>SMS</code> term from the model. However, for visualization and
clarity purposes, we do not make this modification.</p>
</div>
<div id="concurrent-model-coefficients" class="section level3">
<h3>Concurrent model coefficients</h3>
<p>For convenience, we can restate the model in its expectation form to
avoid writing out the noise. Furthermore, we can consider the induced
marginal mean of the outcome, i.e., the expression after marginalizing
over the random effects such that their expectation is zero. For each
mouse <span class="math inline">\(i\)</span> and trial <span class="math inline">\(j\)</span>, we have the covariate vector <span class="math inline">\(\mathbf{X}_{i, j} (s) = [\texttt{SMS}_{i, j},
\texttt{RZ}_{i,j} (s)]^{\intercal}\)</span>. The expectation of the
response given the covariates is:</p>
<p><span class="math display">\[
\mathbb{E} [Y_{i, j}(s) | \mathbf{X}_{i, j} (s) ] =
\beta_0 (s) +
\beta_1 (s) \texttt{SMS}_{i, j} +
\beta_2 (s) \texttt{RZ}_{i, j} (s) +
\beta_3 (s) \texttt{SMS}_{i, j} \texttt{RZ}_{i, j} (s),
\]</span></p>
<p>which can be rearranged</p>
<p><span class="math display">\[
\mathbb{E} [Y_{i, j}(s) | \mathbf{X}_{i, j} (s) ] =
\beta_0 (s) +
\beta_1 (s) \texttt{SMS}_{i, j} +
\texttt{RZ}_{i, j} (s) \left[
\beta_2 (s)  +
\beta_3 (s) \texttt{SMS}_{i, j} \right]
.
\]</span></p>
<p>The second form helps illustrate why <span class="math inline">\(\beta_1 (s)\)</span> should be approximately zero
for all values of <span class="math inline">\(s\)</span>. The fixed
coefficient <span class="math inline">\(\beta_1 (s)\)</span> captures
the contribution of the type of reward, <span class="math inline">\(\texttt{SMS}_{i, j}\)</span>, only when mouse
<span class="math inline">\(i\)</span> on trial <span class="math inline">\(j\)</span> has not yet entered the reward zone,
i.e., <span class="math inline">\(\texttt{RZ}_{i, j} (s) =
0\)</span>.</p>
<p>The fixed coefficient <span class="math inline">\(\beta_3
(s)\)</span>, or the fixed coefficient corresponding to the interaction
term <code>SMS:RZ</code>, is more relevant to interpreting the effect
associated with the SMS reward, though this is not its precise
definition. Defined explicitly, <span class="math inline">\(\beta_3
(s)\)</span> quantifies the contribution of receiving a SMS reward at
<span class="math inline">\(s\)</span> that cannot already be explained
by the total expected signal from receiving a water reward and being in
a trial with SMS. In this case, because we do not see an average signal
change from being in an SMS trial without receiving the reward, <span class="math inline">\(\beta_3 (s)\)</span> roughly corresponds to the
expected signal change from delivering the SMS reward compared to the
water reward at time <span class="math inline">\(s\)</span>. Here, we
have that <span class="math inline">\(\beta_3 (s)\)</span> is
significantly greater than zero for trial timepoints between
approximately 2 seconds to 7 seconds, suggesting that mice experience
greater average signal change when receiving SMS compared to water.</p>
<p>To see this, consider the expected signal for receiving an SMS reward
(top) versus receiving a water reward (bottom):</p>
<p><span class="math display">\[
\mathbb{E} [Y_{i, j}(s) \mid \texttt{SMS}_{i, j} (s) = 1,
\texttt{RZ}_{i, j} = 1] =
\beta_0 (s) + \beta_1 (s) + \beta_2 (s) + \beta_3 (s) ,  \\
\mathbb{E} [Y_{i, j}(s) \mid \texttt{SMS}_{i, j} (s) = 0,
\texttt{RZ}_{i, j} = 1] =
\beta_0 (s)  + \beta_2 (s).
\]</span></p>
<p>The difference between these two expectations is <span class="math inline">\(\beta_1 (s) + \beta_3 (s)\)</span>, which is
approximately <span class="math inline">\(\beta_3 (s)\)</span> if we
consider that <span class="math inline">\(\beta_1 (s) \approx 0\)</span>
across the domain.</p>
</div>
<div id="limitations-of-the-concurrent-model" class="section level3">
<h3>Limitations of the concurrent model</h3>
<p>In most cases with variable trial lengths, we anticipate that
researchers will find the concurrent approach with an interaction term a
useful tool for interpreting the instantaneous relationships between
covariates. However, the concurrent model also has its own set of
drawbacks.</p>
<p>As mentioned previously, the concurrent model cannot fit time points
when the functional covariate has zero variance. Because all mice are
approaching the reward at the start of trial and all mice are rewarded
by the end of the trial, the concurrent FLMM cannot fit the extreme ends
of the trial time frame. Here, this limitation is not relevant because
there are likely no meaningful differences in signal values between SMS
and water before reward delivery because mice are unaware of the reward
they will receive.</p>
<p>Furthermore, within this model, <code>RZ</code> or <span class="math inline">\(\texttt{RZ}_{i, j} (s)\)</span> treats all mice in
the reward zone the same. Coefficient estimates later in the trial may
be unreliable, as the model fits a coefficient estimate to mice that
have recently received a reward and mice that have been waiting in the
reward zone for some time.</p>
<!-- In this experiment in particular, mice are unaware of the reward they will receive when the experiment begins, and trials are unlikely to be meaningfully different within this time period.  -->
<!-- Within this model, `RZ` or $\texttt{RZ}_{i, j} (s)$ treats all mice in the reward zone the same, regardless of how long ago the mouse initially received the reward. Coefficient estimates later in the trial may be unreliable and biased toward zero. Experimenters can address this concern by substituting the indicator variable for a decaying function. However, this approach requires *a priori* assumptions about the trend of photometry signals. Another approach would be to split analysis into faster and slower mice. However, this strategy does not entirely eliminate the concern as regression to the mean still exists, just within smaller batches. Furthermore, it decreases the power of the model and raises concerns about multiple comparison. -->
</div>
</div>
<div id="comparing-concurrent-and-non-concurrent-models" class="section level2">
<h2>Comparing concurrent and non-concurrent models</h2>
<p>Although we demonstrate fitting a concurrent interaction model, it is
also possible fit a non-concurrent model on this dataset. Rather than
convert the scalar covariate of <code>latency</code> to the functional
covariate <code>RZ_1, ..., RZ_L</code>, <code>latency</code> itself can
be incorporated into the model. Generally, this is an option for any
experiment with varying trial lengths. However, <strong>we would advise
against this approach</strong> because the resulting coefficients may be
difficult to interpret.<br />
Thus, this section exists to illustrate a shortcoming of a
non-concurrent approach, and users looking for a practical demonstration
of fitting data may skip it.</p>
<div id="specification-of-the-non-concurrent-model" class="section level3">
<h3>Specification of the non-concurrent model</h3>
<p>To model the problem with the trial latency, we can specify the
<strong>non-concurrent</strong> model</p>
<p><span class="math display">\[
Y_{i, j}(s) =
\beta_0 (s) + \gamma_{i, 0} (s) +
[\beta_1 (s) + \gamma_{i, 1} (s)] \texttt{SMS}_{i, j} +
\beta_2 (s) \texttt{Lat}_{i, j} +
\beta_3 (s) \texttt{SMS}_{i, j} \texttt{Lat}_{i, j} +
\epsilon_{i, j} (s),
\]</span></p>
<p>where <span class="math inline">\(Y_{i, j} (s)\)</span> is the
recorded photometry signal of mouse <span class="math inline">\(i\)</span>, trial <span class="math inline">\(j\)</span>, at trial timepoint <span class="math inline">\(s\)</span>.</p>
<p>We define the scalar covariates</p>
<ul>
<li><span class="math inline">\(\texttt{SMS}_{i, j}\)</span>: the trial
outcome, where <span class="math inline">\(\texttt{SMS}_{i, j} =
1\)</span> for a trial with strawberry milkshake (SMS) and <span class="math inline">\(\texttt{SMS}_{i, j} = 0\)</span> for water,
and</li>
<li><span class="math inline">\(\texttt{Lat}_{i, j}\)</span>: the
latency, in seconds, until mouse <span class="math inline">\(i\)</span>
in trial <span class="math inline">\(j\)</span> received the food
reward. To aid interpretation, we centered the latency values around the
mean latency across all mice and trials. For example, <span class="math inline">\(\texttt{Lat}_{i, j} &lt; 0\)</span> when mouse
<span class="math inline">\(i\)</span> in trial <span class="math inline">\(j\)</span> ran the corridor faster than average
and <span class="math inline">\(\texttt{Lat}_{i, j} &gt; 0\)</span> when
mouse <span class="math inline">\(i\)</span> in trial <span class="math inline">\(j\)</span> ran slower than average.</li>
</ul>
<p>The fixed effect coefficients are</p>
<ul>
<li><span class="math inline">\(\beta_0 (s)\)</span>: the mean signal at
<span class="math inline">\(s\)</span> on water trials when a mouse
responds with an average latency, i.e., when <span class="math inline">\(\texttt{SMS}_{i, j} = \texttt{Lat}_{i, j} =
0\)</span>,</li>
<li><span class="math inline">\(\beta_1 (s)\)</span>: the mean
difference in signals between SMS and water trials when a mouse responds
with an average latency at timepoint <span class="math inline">\(s\)</span>,</li>
<li><span class="math inline">\(\beta_2 (s)\)</span>: the change in mean
signal associated with a one second increase in latency on water trials
at timepoint <span class="math inline">\(s\)</span>, and</li>
<li><span class="math inline">\(\beta_3 (s)\)</span>: the difference
<span class="math inline">\(A - B\)</span> between A) the change in mean
signal associated with a one second increase in latency on SMS trials at
timepoint <span class="math inline">\(s\)</span> and B) the change in
the mean signal associated with a one second increase in latency on
water trials at timepoint <span class="math inline">\(s\)</span> (i.e.,
<span class="math inline">\(\beta_2 (s)\)</span>),</li>
</ul>
<p>and the random effects are</p>
<ul>
<li><span class="math inline">\(\gamma_{i, 0} (s)\)</span>: the random
intercept for mouse <span class="math inline">\(i\)</span>, interpreted
as the subject-specific perturbation of <span class="math inline">\(\beta_0 (s)\)</span> such that <span class="math inline">\(\beta_0 (s) + \gamma_{i, 0} (s)\)</span> is the
average signal at point <span class="math inline">\(s\)</span> for mouse
<span class="math inline">\(i\)</span> on trials with water reward and
average latency, and</li>
<li><span class="math inline">\(\gamma_{i, 1} (s)\)</span>: the random
slope for mouse <span class="math inline">\(i\)</span>, interpreted as
the subject-specific perturbation to <span class="math inline">\(\beta_1
(s)\)</span> such that <span class="math inline">\(\beta_1 (s) +
\gamma_{i, 1} (s)\)</span> is the average signal change associated with
SMS reward at time <span class="math inline">\(s\)</span> on mouse <span class="math inline">\(i\)</span> with average latency.</li>
</ul>
<p>We can fit the non-concurrent model as follows:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>nonconcurrent <span class="ot">&lt;-</span> fastFMM<span class="sc">::</span><span class="fu">fui</span>(</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>  photometry <span class="sc">~</span> SMS <span class="sc">*</span> latency <span class="sc">+</span> (SMS <span class="sc">|</span> id), </span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>  d2pvt, </span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>  <span class="at">concurrent =</span> <span class="cn">FALSE</span>, </span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>  <span class="at">silent =</span> <span class="cn">TRUE</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>)</span></code></pre></div>
<p>Fitting a non-concurrent model with
<code>fastFMM::fui(..., concurrent = FALSE)</code> is the same FLMM
fitting procedure implemented in the previous <code>fastFMM</code>
package versions, described further in <span class="citation">Cui et al.
(<a href="#ref-cui_fast_2022">2022</a>)</span>.</p>
</div>
<div id="non-concurrent-coefficients" class="section level3">
<h3>Non-concurrent coefficients</h3>
<p>The coefficient plot is below:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>sampling_Hz <span class="ot">&lt;-</span> <span class="dv">8</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>dummy <span class="ot">&lt;-</span> fastFMM<span class="sc">::</span><span class="fu">plot_fui</span>(</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>  nonconcurrent, </span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>  <span class="at">x_rescale =</span> sampling_Hz, </span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>  <span class="at">align_x =</span> <span class="dv">3</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>)</span></code></pre></div>
<p>Although the non-concurrent model shows strong trends in the
coefficients, they can be hard to interpret. For example, the dip in the
estimated coefficients for <span class="math inline">\(\beta_2(s)\)</span> and <span class="math inline">\(\beta_3 (s)\)</span> at around 3 seconds does not
necessarily mean that mice with a slower-than-average latency will have
a lower photometry response <em>when they reach the reward</em>. It
could reflect that, in general, rewards increase the photometry signal
magnitude and the slow mice <em>have not yet reached the reward
zone</em>.</p>
<p>We can better illustrate this by referring back to the non-concurrent
model, copied below in expectation form for convenience. Let <span class="math inline">\(\mathbf{X}_{i, j} = [\texttt{SMS}_{i, j},
\texttt{Lat}_{i, j}]^T\)</span> be the covariate matrix for mouse <span class="math inline">\(i\)</span> and trial <span class="math inline">\(j\)</span>.</p>
<p><span class="math display">\[
\mathbb{E} [Y_{i, j}(s) \mid \mathbf{X}_{i, j}] =
\beta_0 (s) +
\beta_1 (s) \texttt{SMS}_{i, j} +
\beta_2 (s) \texttt{Lat}_{i, j} +
\beta_3 (s) \texttt{SMS}_{i, j} \texttt{Lat}_{i, j},
\]</span></p>
<p>To explain the shape of <span class="math inline">\(\beta_2
(s)\)</span> (i.e., the fixed coefficient corresponding to
<code>latency</code>), let’s contrast the expected signal for average
latency (<span class="math inline">\(\texttt{Lat}_{i, j} = 0\)</span>)
versus slower-than-average latency (<span class="math inline">\(\texttt{Lat}_{i, j} = c &gt; 0\)</span> where
<span class="math inline">\(c\)</span> is some arbitrary positive real
value) on a water trial:</p>
<p><span class="math display">\[
\mathbb{E} [Y_{i, j}(s) \mid \texttt{SMS}_{i, j} = 0, \texttt{Lat}_{i,
j} = c &gt; 0] = \beta_0 (s) + c \beta_2 (s) \\
\mathbb{E} [Y_{i, j}(s) \mid \texttt{SMS}_{i, j} = 0, \texttt{Lat}_{i,
j} = 0] = \beta_0 (s).
\]</span></p>
<p>The curve of <span class="math inline">\(\beta_0 (s)\)</span>
reflects the expected signal for a mouse running an average latency. For
some timepoints after the average latency, the first equation (slow
mouse) reflects the expected photometry signal of a mouse that has not
yet reached the reward while the second equation reflects a mouse that
has just received the reward. Both equations contain <span class="math inline">\(\beta_0 (s)\)</span> (the intercept), but we
assume that the slow mouse will have a lower expected signal. Thus, the
negative contribution of <span class="math inline">\(c \beta_2
(3)\)</span> could be interpreted as offsetting the intercept for slow
mice and may not be meaningfully related to the reward.</p>
<p>The shape of the coefficient curve for the interaction
<code>SMS:latency</code> also shows a dip. However, it is not the case
that this implies that slow mice exhibit decreased average signal
association with the SMS reward. Again, let’s write out the expressions
for different latencies in a SMS trial:</p>
<p><span class="math display">\[
\mathbb{E} [Y_{i, j}(s) \mid \texttt{SMS}_{i, j} = 1, \texttt{Lat}_{i,
j} = c &gt; 0] = \beta_0 (s) + \beta_1 (s) + c \beta_2 (s) + c \beta_3
(s) \\
\mathbb{E} [Y_{i, j}(s) \mid \texttt{SMS}_{i, j} = 1, \texttt{Lat}_{i,
j} = 0] = \beta_0 (s) + \beta_1 (s).
\]</span></p>
<p>We encounter a similar problem, where for some <span class="math inline">\(s\)</span> after the reward is received, the
expression when conditioning on slow latencies contains the expression
capturing the signal on average latencies. Thus, the shape of <span class="math inline">\(\beta_3 (s)\)</span> (corresponding to
<code>SMS:latency</code> in the plot) may be explained as a compensation
for the strongly positive <span class="math inline">\(\beta_2
(s)\)</span> (<code>SMS</code>) main effect functional coefficient for
slower-than-average mice.</p>
</div>
<div id="comparing-the-non-concurrent-and-concurrent-model" class="section level3">
<h3>Comparing the non-concurrent and concurrent model</h3>
<p>Unlike the non-concurrent model, the concurrent model does not
contain potentially misleading interpretations between a time-related
summary statistic and the functional outcome. Transforming the scalar
latency value to the functional covariate <span class="math inline">\(\texttt{RZ}_{i, j} (s)\)</span> appropriately
separates mice that have reached the reward zone and mice that are still
in the corridor, allowing the experimenter to better visualize the
association between the time-varying behavior and photometry signal.
Within the non-concurrent FLMM, the instantaneous interpretation of the
coefficients is less pertinent to the question of identifying the
association between the average signal and behavior. In experiments with
variable trial lengths, we anticipate that researchers will find the
concurrent approach more applicable.</p>
</div>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="unnumbered">References</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-cui_fast_2022" class="csl-entry">
Cui, Erjia, Andrew Leroux, Ekaterina Smirnova, and Ciprian M.
Crainiceanu. 2022. <span>“Fast <span>Univariate</span>
<span>Inference</span> for <span>Longitudinal</span>
<span>Functional</span> <span>Models</span>.”</span> <em>Journal of
Computational and Graphical Statistics</em> 31 (1): 219–30. <a href="https://doi.org/10.1080/10618600.2021.1950006">https://doi.org/10.1080/10618600.2021.1950006</a>.
</div>
<div id="ref-cui_fastfmm_2025" class="csl-entry">
Cui, Erjia, Gabriel Loewinger, and Al Xin. 2025. <span>“<span class="nocase">fastFMM</span>: <span>Fast</span> <span>Functional</span>
<span>Mixed</span> <span>Models</span> Using <span>Fast</span>
<span>Univariate</span> <span>Inference</span>.”</span> <a href="https://cran.csail.mit.edu/web/packages/fastFMM/index.html">https://cran.csail.mit.edu/web/packages/fastFMM/index.html</a>.
</div>
<div id="ref-machen_encoding_2025" class="csl-entry">
Machen, Briana, Sierra N. Miller, Al Xin, Carine Lampert, Lauren Assaf,
Julia Tucker, Francisco Pereira, Gabriel Loewinger, and Sofia Beas.
2025. <span>“The Encoding of Interoceptive-Based Predictions by the
Paraventricular Nucleus of the Thalamus <span>D2</span>+
Neurons.”</span> <a href="https://doi.org/10.1101/2025.03.10.642469">https://doi.org/10.1101/2025.03.10.642469</a>.
</div>
<div id="ref-xin_capturing_2025" class="csl-entry">
Xin, Al W., Erjia Cui, Francisco Pereira, and Gabriel Loewinger. 2025.
<span>“Capturing Instantaneous Neural Signal-Behavior Relationships with
Concurrent Functional Mixed Models.”</span> bioRxiv. <a href="https://doi.org/10.1101/2025.09.08.671383">https://doi.org/10.1101/2025.09.08.671383</a>.
</div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
